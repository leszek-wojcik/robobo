---
layout: post
title:  "Arduino Controlled Servo - PID"
date:   2018-04-01 11:19:00 +0100
excerpt: "This guide explain what PID is and how to implement it on Arduino"
categories: encoder robobo Motor Arduino PID
---

Responsibility of Arduino
[servo](https://leszek-wojcik.github.io/robobo/arduino/servo/encoder/pololu/hbridge/pid/2017/12/29/servo.html)
controller is to calculate voltage value and duration in which voltage is
applied to motor terminals. Goal of controller is to get motor shaft position
aligned to requested. In this material I will describe PID controller - one of
most common control algorithm in industry. PID description presented here was
created with assumption that [control
theory](https://en.wikipedia.org/wiki/Control_theory) background in not needed.


# PID - introduction

Lets try to sum up what control algorithm is for our case. 

- Algorithm takes requested position as input
- Algorithm takes current shaft position as input
- Algorithm produces voltage value as output

On top of that we need to be aware that we are controlling dynamic object (dc motor) so we
should also expect that our algorithm itself should be dynamic as well. 
What does mean dynamic in this case ? Dynamic means that depending on time
factor algorithm might produce different output for same input. This could be
confusing. For a moment please ignore this as I will describe it in more
details later on. In order to keep order I will make a note to the ones above:

- For same Algorithm output might wary depending on its internal state

# PID - Proportional

The letter P in PID stands for "proportional". In here I would like you to imagine
a spring as you know. Spring have a property that makes it interesting from
control perspective. If you try to squeeze a spring it will return to its
original shape. Same goes for stretching. You might keep your spring stretched
for a moment and you will notice that as you are putting a force to keep it
stretched the spring is giving you same amount of force to in opposite
direction because it want to go back to its original shape. If you already had
a physic class you might already know that force that spring is giving back is
*proportional* to length that spring is out of its original.

At this moment we should think how spring could act as our control algorithm.
If we could attach a spring to our motor shaft in such a way that in our
requested position spring would be its original length then spring would do
actually make our shaft to always go back to requested position. Obviously
spring would have to be strong enough to do so. I hope you can see that.

*OK. But does it have anything to do with out control algorithm?*

Yes - because at this point we will be implementing algorithm that will behave
exactly the same that our imaginary spring. Firstly we calculate how far our
imaginary spring is from its original length (rest position).

```c
diff = motor->getRequestedPosition() - motor->getCurrentPosition();
dcOutput = calculateControl(diff); 

```

`diff` is an imaginary offset from original length. We take it and then
calculating control which suppose to be our voltage

```c
int32_t calculateControl(int32_t diff)
{
    return diff *kP;
}
```

`kP` is our spring property.

And finally we need to apply our control to dc motor:

```c
if (dcOutput < 0 )
{
    motor->setDirectionLeft();
}
else
{
    motor->setDirectionRight();
}

dcOutput = abs(dcOutput);

//need to scale target value to range 0-255 PWM
if (dcOutput >255)
    dcOutput = 255;

if (!motor->isStopped())
    motor->setVoltage(dcOutput);
```

One more thing that might require to comment is scaling `dcOutput` to 255.
Rationale behind that is quite simple. `setVoltage` method directly maps to
Arduino `analogWrite` function that expect `uint8_t` as input so line here is
to perform scaling functionality visible for anyone. Moreover in future we
might even want to limit voltage that we apply to DC motor with for instance
`100` then we will just substitute this number.


# PID - Integral

TBD

# PID - canonical form

TBD


